{% extends 'navbar.html' %}
{% block head%}{% endblock %}
{% block body%}
    <!--
    <div id="items">
        <p id="mess"></p>
        <input type="text" id="input">
        <button id="send">Send</button>
    </div>
    <button class="room">Vanila</button>
    <button class="room">Chocolate</button>
    -->
    <div class="card purple lighten-4 chat-room">
        <div class="card-body">
      
          <!-- Grid row -->
          <div class="row px-2">
      
            <!-- Grid column -->
            <div class="col-md-6 col-xl-8 pr-md-4 px-lg-auto px-0">
      
              <div class="chat-message">
                
                <ul class="list-unstyled chat">
                    <div id="messages">
                        {% for i in msgs %}
                            <li class="d-flex justify-content-between mb-4">
                                <div class="chat-body white p-3 ml-2 z-depth-1">
                                    <div class="header">
                                        <strong class="primary-font">{{username}}</strong>
                                        <small class="pull-right text-muted"><i class="far fa-clock"></i>min ago</small>
                                    </div>
                                    <hr class="w-100">
                                    <p>
                                        {{i.message}}
                                    </p>
                                </div>
                            </li>
                        {% endfor %}
                    </div>
                    <br>
                  <li class="white">
                    <div class="form-group basic-textarea">
                      <input type="text" class="form-control pl-2 my-0" id="input" rows="3" placeholder="Type your message here..."></input>
                    </div>
                  </li>
                  <button type="button" class="btn btn-deep-purple btn-rounded btn-sm waves-effect waves-light float-right" id="send">Send</button>
                </ul>
      
              </div>
      
            </div>
            <!-- Grid column -->
      
            <!-- Grid column -->
            <div class="col-md-6 col-xl-4 px-0">
      
              <h6 class="font-weight-bold mb-3 text-center text-lg-left">Friends</h6>
              <div class="white z-depth-1 px-3 pt-3 pb-0">
                <ul class="list-unstyled friend-list">
                  <li class="active grey lighten-3 p-2">
                    <a href="#" class="d-flex justify-content-between">
                      <div class="text-small">
                        <strong>First username</strong>
                        <p class="last-message text-muted">Last message.</p>
                      </div>
                      <div class="chat-footer">
                        <p class="text-smaller text-muted mb-0">sent x min ago</p>
                        <span class="badge badge-danger float-right">unread msgs</span>
                      </div>
                    </a>
                  </li>
                  <li class="p-2">
                    <a href="#" class="d-flex justify-content-between">
                      <div class="text-small">
                        <strong>Second username</strong>
                        <p class="last-message text-muted">Last message.</p>
                      </div>
                      <div class="chat-footer">
                        <p class="text-smaller text-muted mb-0">sent x min ago</p>
                        <span class="text-muted float-right"><i class="fas fa-mail-reply" aria-hidden="true"></i></span>
                      </div>
                    </a>
                  </li>
                </ul>
              </div>
      
            </div>
            <!-- Grid column -->
      
          </div>
          <!-- Grid row -->
      
        </div>
      </div>
    
<script>
    room = ""
    var socket = io("http://127.0.0.1:5000");
    var join_room = false;
    socket.on('connect', function() {
        socket.send("Connected!")
    });
    socket.on("message", function(msg){ // add connected handler
        msg = addNewlines(msg)
        console.log(socket)
        console.log("recived")
        var create_msg = `<li class="d-flex justify-content-between mb-4">
                        <div class="chat-body white p-3 ml-2 z-depth-1">
                            <div class="header">
                                <strong class="primary-font">{{username}}</strong>
                                <small class="pull-right text-muted"><i class="far fa-clock"></i>min ago</small>
                            </div>
                            <hr class="w-100">
                            <p id="new-msg">` + 
                                msg 
                                +
                                `
                            </p>
                        </div>
                    </li>`
        $("#messages").append(create_msg)
    });

    $("#send").click(function(){
        console.log(join_room)
        if(join_room){
            console.log("Room")
            socket.send({"message" : $("#input").val(), "room" : room})
        }
        else{
            console.log($("#input").val());
            socket.send($("#input").val());
        }
    });
    $(".room").click(function(event){
        var new_room = $(event.target).text()
        console.log(new_room);
        if(room == new_room){
            socket = io("http://127.0.0.1:5000");
            alert("You are already in the room!")
        }
        else{
            join_room = true;
            $("#messages").html("");
            socket.emit('leave', {"room" : room})
            socket.emit("join", {"room" : new_room})
            alert("You joined " + new_room)
            room = new_room
        }
    });
    function addNewlines(str) {
    var result = '';
    while (str.length > 0) {
        result = result + str.substring(0, 120) + '\n';
        str = str.substring(120);
    }
    return result;
    }
</script>
<style>
#messages{
  width: 100%;
  height: 690px;
  overflow: scroll;
  overflow-x: hidden;
}

#messages::-webkit-scrollbar-track
{
    border-radius: 10px;
    background-color: #F5F5F5;
}

#messages::-webkit-scrollbar
{
    width: 12px;
    background-color: #F5F5F5;
}

#messages::-webkit-scrollbar-thumb
{
    border-radius: 10px;
    background-color: #D62929;
}



</style>
{% endblock %}